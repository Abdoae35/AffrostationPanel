@model List<TreeReadVM>

@{
    ViewBag.Title = "Show All Trees";
    Layout = "_Layout";
    var groupedTrees = Model.GroupBy(t => t.Type);
}

<!-- âœ… TYPE BUTTONS CARD -->
<div class="card shadow-sm border-0 mx-auto mt-4" style="max-width: 600px; border-radius: 15px;">
    <div class="card-body text-center">
        <h5 class="fw-bold mb-3" style="color:#14ae64;">ğŸŒ¿ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù†Ø¨Ø§ØªØ§Øª</h5>

        <div class="d-flex justify-content-center flex-wrap gap-2">
            @foreach (var type in groupedTrees)
            {
                <button type="button" class="btn tree-type-btn"
                        data-typeid="@type.First().TypeId"
                        style="color:#14ae64; border:1px solid #14ae64; background-color:white; min-width:80px;">
                    @type.Key
                </button>
            }
        </div>
    </div>
</div>

<!-- âœ… CONTAINER FOR LOADED TREES -->
<div id="treeDataContainer" class="mt-4 text-center">
    <p class="text-muted">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù†Ø¨Ø§Øª Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ğŸŒ±</p>
</div>

<!-- âœ… ADD TREE MODAL (unchanged from old one) -->
<div class="modal fade" id="addTreeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content shadow-lg">
            <div class="modal-header">
                <h5 class="modal-title text-success">â• Ø§Ø¶Ø§ÙØ© Ù†Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="treeTypeInput" />
                <div class="mb-3">
                    <label class="form-label">ğŸŒ¿ Ø§Ø³Ù… Ø§Ù„Ù†Ø¨Ø§Øª</label>
                    <input type="text" class="form-control" id="newTreeName" />
                </div>
                <div class="mb-3">
                    <label class="form-label">ğŸ”¬ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ù„Ù…ÙŠ</label>
                    <input type="text" class="form-control" id="newScientificName" />
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Ø§ØºÙ„Ø§Ù‚</button>
                <button class="btn btn-success" id="saveTreeBtn">Ø­ÙØ¸</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let currentTypeId = 0;
    let currentTypeName = "";

    // When user clicks a Type Button
    $(document).on("click", ".tree-type-btn", function () {
        currentTypeId = $(this).data("typeid");
        currentTypeName = $(this).text().trim();

        // Highlight selected and mark active
        $(".tree-type-btn").removeClass("active").css("background-color", "white").css("color", "#14ae64");
        $(this).addClass("active").css("background-color", "#14ae64").css("color", "white");

        // Fetch data via AJAX
        $.ajax({
            url: `/ShowData/GetAllTreeWithTypeId?typeId=${currentTypeId}`,
            type: "GET",
            success: function (res) {
                if (res.success) {
                    renderTreeTable(res.data);
                } else {
                    $("#treeDataContainer").html(`<div class='alert alert-danger'>${res.message}</div>`);
                }
            },
            error: function () {
                $("#treeDataContainer").html(`<div class='alert alert-danger'>âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>`);
            }
        });
    });

    // Render Tree Table (unchanged)
    function renderTreeTable(trees) {
        if (trees.length === 0) {
            $("#treeDataContainer").html(`<div class='alert alert-warning text-center'>âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø¨Ø§ØªØ§Øª Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹</div>`);
            return;
        }

        let rows = trees.map(t => `
            <tr data-id="${t.id}">
                <td>${t.name}</td>
                <td>${t.scientificName}</td>
                <td>
                    <div class="d-flex gap-2 justify-content-center">
                        <button class="btn btn-warning btn-sm edit-tree" data-id="${t.id}">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn btn-success btn-sm save-tree d-none" data-id="${t.id}">Ø­ÙØ¸</button>
                        <button class="btn btn-secondary btn-sm cancel-edit d-none">Ø§Ù„ØºØ§Ø¡</button>
                        <button class="btn btn-danger btn-sm delete-tree" data-id="${t.id}">Ø­Ø°Ù</button>
                    </div>
                </td>
            </tr>
        `).join("");

        let html = `
            <div class="table-responsive mx-auto" style="max-width: 600px;">
                <table class="table table-hover table-bordered align-middle text-center shadow-sm">
                    <thead style="background-color: #14ae64; color:white;">
                        <tr>
                            <th colspan="3" class="p-2 w-100">
                                <div class="d-flex justify-content-center align-items-center position-relative w-100">
                                    <span class="fw-bold mx-auto">${currentTypeName}</span>
                                    <button class="btn btn-light btn-sm text-success add-tree-btn position-absolute end-0 me-2"
                                            data-typeid="${currentTypeId}" data-typename="${currentTypeName}">
                                        â• Ø§Ø¶Ø§ÙØ© Ù†Ø¨Ø§Øª
                                    </button>
                                </div>
                            </th>
                        </tr>
                        <tr>
                            <th>Ø§Ø³Ù… Ø§Ù„Ù†Ø¨Ø§Øª</th>
                            <th>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ù„Ù…ÙŠ</th>
                            <th>Ø¥Ø¯Ø§Ø±Ø©</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>`;
        $("#treeDataContainer").html(html);
    }

    // Add New Tree Modal â€” make sure we set currentTypeId when opening modal
    $(document).on("click", ".add-tree-btn", function () {
        // set current type id and name from the clicked add button (table header add)
        currentTypeId = $(this).data("typeid") || currentTypeId;
        currentTypeName = $(this).data("typename") || currentTypeName;

        $("#treeTypeInput").val(currentTypeName);
        $("#newTreeName").val("");
        $("#newScientificName").val("");
        new bootstrap.Modal(document.getElementById('addTreeModal')).show();
    });

    // Save New Tree â€” hide modal properly and reload by type id
    $("#saveTreeBtn").click(function () {
        let name = $("#newTreeName").val().trim();
        let scientific = $("#newScientificName").val().trim();
        let typeName = $("#treeTypeInput").val();

        if (name === "" || scientific === "") {
            alert("âš ï¸ ÙŠØ¬Ø¨ Ø§Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ù„Ù…ÙŠ");
            return;
        }

        // disable button to prevent double clicks
        $(this).prop("disabled", true);

        $.ajax({
            url: `/AddNewTree/AddTree`,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                Name: name,
                ScientificName: scientific,
                TreeType: typeName
            }),
            success: function (res) {
                $("#saveTreeBtn").prop("disabled", false);
                if (res.success) {
                    // Properly hide the currently open modal instance
                    const modalEl = document.getElementById('addTreeModal');
                    const modalInstance = bootstrap.Modal.getInstance(modalEl);
                    if (modalInstance) {
                        modalInstance.hide();
                    } else {
                        // fallback: create and hide (rare)
                        new bootstrap.Modal(modalEl).hide();
                    }

                    // Refresh the current type table â€” use typeid (preferred) if available
                    if (currentTypeId && $(".tree-type-btn[data-typeid='" + currentTypeId + "']").length) {
                        $(".tree-type-btn[data-typeid='" + currentTypeId + "']").click();
                    } else {
                        // fallback: reload the selected active button if any
                        $(".tree-type-btn.active").click();
                    }
                } else {
                    alert(res.message || "âŒ ÙØ´Ù„ Ø§Ø¶Ø§ÙØ© Ø§Ù„Ù†Ø¨Ø§Øª");
                }
            },
            error: function () {
                $("#saveTreeBtn").prop("disabled", false);
                alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…");
            }
        });
    });

    // Edit, cancel and save handlers â€” small fix for cancel to use .active
    $(document).on("click", ".edit-tree", function () {
        let row = $(this).closest("tr");
        let name = row.find("td:eq(0)").text().trim();
        let scientific = row.find("td:eq(1)").text().trim();

        row.find("td:eq(0)").html(`<input type="text" class="form-control new-name" value="${name}" />`);
        row.find("td:eq(1)").html(`<input type="text" class="form-control new-scientific" value="${scientific}" />`);
        row.find(".edit-tree, .delete-tree").addClass("d-none");
        row.find(".save-tree, .cancel-edit").removeClass("d-none");
    });

    $(document).on("click", ".cancel-edit", function () {
        // reload the current active type (if exists)
        if ($(".tree-type-btn.active").length) {
            $(".tree-type-btn.active").click();
        } else if (currentTypeId) {
            $(".tree-type-btn[data-typeid='" + currentTypeId + "']").click();
        } else {
            location.reload(); // fallback
        }
    });

    $(document).on("click", ".save-tree", function () {
        let row = $(this).closest("tr");
        let id = $(this).data("id");
        let name = row.find(".new-name").val().trim();
        let scientific = row.find(".new-scientific").val().trim();

        if (name === "" || scientific === "") {
            alert("âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ±Ùƒ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ù„Ù…ÙŠ ÙØ§Ø±ØºÙ‹Ø§");
            return;
        }

        $.ajax({
            url: `/ShowData/UpdateTree`,
            type: "PUT",
            contentType: "application/json",
            data: JSON.stringify({ Id: id, Name: name, ScientificName: scientific }),
            success: function (res) {
                if (res.success) {
                    // refresh current type table
                    if (currentTypeId) $(".tree-type-btn[data-typeid='" + currentTypeId + "']").click();
                } else {
                    alert(res.message || "âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«");
                }
            },
            error: function () {
                alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¨Ø§Øª");
            }
        });
    });

    $(document).on("click", ".delete-tree", function () {
        let id = $(this).data("id");
        if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¨Ø§ØªØŸ")) {
            $.ajax({
                url: `/ShowData/DeleteTree/${id}`,
                type: "DELETE",
                success: function (res) {
                    if (res.success) {
                        if (currentTypeId) $(".tree-type-btn[data-typeid='" + currentTypeId + "']").click();
                    } else {
                        alert(res.message);
                    }
                }
            });
        }
    });
</script>

}
