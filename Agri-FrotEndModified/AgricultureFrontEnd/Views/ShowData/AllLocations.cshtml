@model List<LocationNameReadVM>

@{
    ViewBag.Title = "Show All Locations";
    Layout = "_Layout";
    var groupedLocations = Model.GroupBy(l => l.LocationType);
}

<!-- âœ… TYPE BUTTONS CARD -->
<div class="card shadow-sm border-0 mx-auto mt-4" style="max-width: 600px; border-radius: 15px;">
    <div class="card-body text-center">
        <h5 class="fw-bold mb-3" style="color:#14ae64;">ğŸ¡ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</h5>

        <div class="d-flex justify-content-center flex-wrap gap-2">
            @foreach (var type in groupedLocations)
            {
                <button type="button" class="btn location-type-btn"
                        data-typeid="@type.First().LocationTypeId"
                        style="color:#14ae64; border:1px solid #14ae64; background-color:white; min-width:80px;">
                    @type.Key
                </button>
            }
        </div>
    </div>
</div>

<!-- âœ… CONTAINER FOR LOADED LOCATIONS -->
<div id="locationDataContainer" class="mt-4 text-center">
    <p class="text-muted">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ğŸ </p>
</div>

<!-- âœ… ADD LOCATION MODAL -->
<div class="modal fade" id="addLocationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content shadow-lg">
            <div class="modal-header">
                <h5 class="modal-title text-success">â• Ø§Ø¶Ø§ÙØ© Ù…ÙˆÙ‚Ø¹ Ø¬Ø¯ÙŠØ¯</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="locationTypeInput" />
                <div class="mb-3">
                    <label class="form-label">ğŸ¡ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
                    <input type="text" class="form-control" id="newLocationName" />
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Ø§ØºÙ„Ø§Ù‚</button>
                <button class="btn btn-success" id="saveLocationBtn">Ø­ÙØ¸</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let currentTypeId = 0;
    let currentTypeName = "";

    // âœ… When user clicks a Location Type button
    $(document).on("click", ".location-type-btn", function () {
        currentTypeId = $(this).data("typeid");
        currentTypeName = $(this).text().trim();

        console.log("ğŸ”¹ Selected TypeId:", currentTypeId);

        // Highlight selected button
        $(".location-type-btn").css({
            "background-color": "white",
            "color": "#14ae64"
        });
        $(this).css({
            "background-color": "#14ae64",
            "color": "white"
        });

        // âœ… Fetch data via AJAX (fixed)
        $.ajax({
            url: '/ShowData/GetAllLocationWithTypeId',
            type: 'GET',
            data: { typeId: currentTypeId }, // âœ… correct parameter name and value
            success: function (res) {
                if (res.success) {
                    console.log("âœ… Data received for TypeId:", currentTypeId);
                    renderLocationTable(res.data);
                } else {
                    $("#locationDataContainer").html(`<div class='alert alert-danger'>${res.message}</div>`);
                }
            },
            error: function () {
                $("#locationDataContainer").html(`<div class='alert alert-danger'>âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>`);
            }
        });
    });

    // âœ… Render Location Table
    function renderLocationTable(locations) {
        if (locations.length === 0) {
            $("#locationDataContainer").html(`<div class='alert alert-warning text-center'>âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ù‚Ø¹ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹</div>`);
            return;
        }

        let rows = locations.map(l => `
            <tr data-id="${l.id}">
                <td>${l.name}</td>
                <td>
                    <div class="d-flex gap-2 justify-content-center">
                        <button class="btn btn-warning btn-sm edit-location" data-id="${l.id}">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn btn-success btn-sm save-location d-none" data-id="${l.id}">Ø­ÙØ¸</button>
                        <button class="btn btn-secondary btn-sm cancel-edit d-none">Ø§Ù„ØºØ§Ø¡</button>
                        <button class="btn btn-danger btn-sm delete-location" data-id="${l.id}">Ø­Ø°Ù</button>
                    </div>
                </td>
            </tr>
        `).join("");

        let html = `
            <div class="table-responsive mx-auto" style="max-width: 600px;">
                <table class="table table-hover table-bordered align-middle text-center shadow-sm">
                    <thead style="background-color: #14ae64; color:white;">
                        <tr>
                            <th colspan="2" class="p-2 w-100">
                                <div class="d-flex justify-content-center align-items-center position-relative w-100">
                                    <span class="fw-bold mx-auto">${currentTypeName}</span>
                                    <button class="btn btn-light btn-sm text-success add-location-btn position-absolute end-0 me-2"
                                            data-typeid="${currentTypeId}" data-typename="${currentTypeName}">
                                        â• Ø§Ø¶Ø§ÙØ© Ù…ÙˆÙ‚Ø¹
                                    </button>
                                </div>
                            </th>
                        </tr>
                        <tr>
                            <th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                            <th>Ø¥Ø¯Ø§Ø±Ø©</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>`;
        $("#locationDataContainer").html(html);
    }

    // âœ… Add New Location Modal
    $(document).on("click", ".add-location-btn", function () {
        $("#locationTypeInput").val($(this).data("typename"));
        $("#newLocationName").val("");
        new bootstrap.Modal(document.getElementById('addLocationModal')).show();
    });

    // âœ… Save New Location
    $("#saveLocationBtn").click(function () {
        let name = $("#newLocationName").val().trim();
        let type = $("#locationTypeInput").val();

        if (name === "") {
            alert("âš ï¸ ÙŠØ¬Ø¨ Ø§Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹");
            return;
        }

        $.ajax({
            url: `/AddNewLocation/AddLocation`,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({ Name: name, LocationType: type }),
            success: function (res) {
                if (res.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addLocationModal'));
                    modal.hide();
                    $(".location-type-btn[data-typeid='" + currentTypeId + "']").click();
                    alert("âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­");
                } else {
                    alert("âŒ ÙØ´Ù„ Ø§Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹");
                }
            },
            error: function () {
                alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…");
            }
        });
    });

    // âœ… Edit, Save, Cancel, Delete

    $(document).on("click", ".edit-location", function () {
        let row = $(this).closest("tr");
        let name = row.find("td:eq(0)").text().trim();

        row.find("td:eq(0)").html(`<input type="text" class="form-control new-name" value="${name}" />`);
        row.find(".edit-location, .delete-location").addClass("d-none");
        row.find(".save-location, .cancel-edit").removeClass("d-none");
    });

    $(document).on("click", ".cancel-edit", function () {
        $(".location-type-btn[data-typeid='" + currentTypeId + "']").click();
    });

    $(document).on("click", ".save-location", function () {
        let row = $(this).closest("tr");
        let id = $(this).data("id");
        let name = row.find(".new-name").val().trim();

        if (name === "") {
            alert("âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ±Ùƒ Ø§Ù„Ø§Ø³Ù… ÙØ§Ø±ØºÙ‹Ø§");
            return;
        }

        $.ajax({
            url: `/ShowData/UpdateLocation`,
            type: "PUT",
            contentType: "application/json",
            data: JSON.stringify({ Id: id, Name: name, LocationTypeId: currentTypeId }),
            success: function (res) {
                if (res.success) {
                    $(".location-type-btn[data-typeid='" + currentTypeId + "']").click();
                } else {
                    alert(res.message);
                }
            },
            error: function () {
                alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹");
            }
        });
    });

    $(document).on("click", ".delete-location", function () {
        let id = $(this).data("id");
        if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŸ")) {
            $.ajax({
                url: `/ShowData/DeleteLocation/${id}`,
                type: "DELETE",
                success: function (res) {
                    if (res.success) {
                        $(".location-type-btn[data-typeid='" + currentTypeId + "']").click();
                    } else {
                        alert(res.message);
                    }
                }
            });
        }
    });
</script>
}
